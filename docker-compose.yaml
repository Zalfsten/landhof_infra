services:
  civicrm-app:
    build: .
    user: www-data:www-data
    ports:
      - 8760:8080 # CiviCRM will be available on port 8760.
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      civicrm-install:
        condition: service_completed_successfully
    volumes:
      - civicrm_private:/var/www/html/private:rw
      - civicrm_public:/var/www/html/public:rw
      - civicrm_ext:/var/www/html/ext:ro
    environment:
      CIVICRM_DB_HOST: db
      CIVICRM_DB_PORT: 3306
      CIVICRM_DB_NAME: civicrm
      CIVICRM_DB_USER: civicrm
      CIVICRM_DB_PASSWORD: ${MYSQL_PASSWORD}
      CIVICRM_UF_BASEURL: http://localhost:8760
      APACHE_RUN_USER: www-data
      APACHE_PORT: 8080
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/civicrm/home || [ $? -eq 22 ]"]
      interval: 5s
      timeout: 4s
      start_period: 30s
      retries: 3
    networks:
      - app-db
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - DAC_OVERRIDE

  civicrm-cron:
    build: .
    user: www-data:www-data
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      civicrm-install:
        condition: service_completed_successfully
    volumes:
      - civicrm_private:/var/www/html/private:rw
      - civicrm_public:/var/www/html/public:rw
      - civicrm_ext:/var/www/html/ext:ro
    environment:
      CIVICRM_DB_HOST: db
      CIVICRM_DB_PORT: 3306
      CIVICRM_DB_NAME: civicrm
      CIVICRM_DB_USER: civicrm
      CIVICRM_DB_PASSWORD: ${MYSQL_PASSWORD}
      CIVICRM_UF_BASEURL: http://localhost:8760
    entrypoint: ["/run-cron.sh"]
    command: []
    healthcheck:
      test: ["CMD-SHELL", "pgrep supercronic > /dev/null || exit"]
      interval: 5s
      timeout: 4s
      start_period: 4s
      retries: 3
    networks:
      - cron-db
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - DAC_OVERRIDE

  civicrm-install:
    build: .
    user: www-data:www-data
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - civicrm_private:/var/www/html/private:rw
      - civicrm_public:/var/www/html/public:rw
      - civicrm_ext:/var/www/html/ext:rw
    environment:
      CIVICRM_ADMIN_PASSWORD: ${CIVICRM_ADMIN_PASSWORD}
      CIVICRM_CRED_KEYS: ${CIVICRM_CRED_KEYS}
      CIVICRM_SIGN_KEYS: ${CIVICRM_SIGN_KEYS}
      CIVICRM_SITE_KEY: ${CIVICRM_SITE_KEY}
    entrypoint: ["bash", "-c",
      "echo 'Starting CiviCRM installation as www-data...' && \
      cv core:install -K -n \
        --url=http://localhost:8760 \
        --db=mysql://civicrm:${MYSQL_PASSWORD}@db:3306/civicrm \
        --lang=de_DE \
        -m extras.adminUser=admin \
        -m extras.adminPass=${CIVICRM_ADMIN_PASSWORD} \
        -m extras.adminEmail=admin@example.com && \
      chmod 400 /var/www/html/private/civicrm.settings.php && \
      echo 'Patching CIVICRM_SITE_KEY in civicrm.settings.php ...' && \
      sed -i \"s/define('CIVICRM_SITE_KEY'.*/define('CIVICRM_SITE_KEY', '${CIVICRM_SITE_KEY}');/\" /var/www/html/private/civicrm.settings.php && \
      echo 'Patching CIVICRM_CRED_KEYS in civicrm.settings.php ...' && \
      sed -i \"s/define('CIVICRM_CRED_KEYS'.*/define('CIVICRM_CRED_KEYS', '${CIVICRM_CRED_KEYS}');/\" /var/www/html/private/civicrm.settings.php && \
      echo 'Patching CIVICRM_SIGN_KEYS in civicrm.settings.php ...' && \
      sed -i \"s/define('CIVICRM_SIGN_KEYS'.*/define('CIVICRM_SIGN_KEYS', '${CIVICRM_SIGN_KEYS}');/\" /var/www/html/private/civicrm.settings.php && \
      echo 'Installation completed, configuring additional settings...' && \
      cv api4 Setting.set +v debug_enabled=0 && \
      cv api4 Setting.set +v backtrace=0 && \
      echo 'CiviCRM installation completed successfully!'"]
    restart: "no"
    networks:
      - install-db
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - DAC_OVERRIDE
  
      # cv api4 Domain.create values='{\"name\":\"Landhof Organisation\",\"description\":\"Landhof Vereinsmanagement System\"}' && \
      # cv api4 Setting.create values='{\"display_name_format\":\"%{first_name} %{last_name}\"}' && \
      # cv api4 Setting.create values='{\"sort_name_format\":\"%{last_name}, %{first_name}\"}' && \
      # cv api4 Setting.create values='{\"default_from_email_address\":\"landhof@example.com\"}' && \
      # cv api4 Setting.create values='{\"site_name\":\"Landhof Vereinsmanagement\"}' && \
      # cv api4 Setting.create values='{\"debug_enabled\":false}' && \
      # cv api4 Setting.create values='{\"backtrace\":false}' && \
      # cv api4 MailSettings.create values='{\"name\":\"Landhof Mail\",\"domain\":\"example.com\",\"localpart\":\"landhof\",\"return_path\":\"landhof@example.com\",\"protocol\":\"SMTP\",\"server\":\"localhost\",\"port\":25,\"is_default\":1}' && \

  db:
    hostname: db
    image: mariadb:12.0.2
    restart: unless-stopped
    user: mysql:mysql
    volumes:
      - db:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: civicrm
      MYSQL_USER: civicrm
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - app-db
      - cron-db
      - install-db
    cap_drop:
      - ALL

volumes:
  db:
  civicrm_private:
  civicrm_public:
  civicrm_ext:

networks:
  app-db:
  cron-db:
  install-db:
